<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta charset="utf-8">
  <title>å—ä»˜ã‚¹ã‚­ãƒ£ãƒŠãƒ¼</title>
  <style>
    /* ãƒ™ãƒ¼ã‚¹ã‚¹ã‚¿ã‚¤ãƒ« */
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: #f0f2f5; color: #333; padding: 10px; text-align: center; padding-bottom: 80px; }
    .container { max-width: 600px; margin: 0 auto; background: #fff; padding: 15px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
    
    #login-ui { display: block; padding: 30px 10px; }
    .login-input { padding: 12px; font-size: 16px; width: 80%; border: 1px solid #ccc; border-radius: 6px; margin-bottom: 15px; }
    .btn-login { padding: 12px 30px; background: #333; color: white; border: none; border-radius: 50px; font-size: 16px; font-weight: bold; cursor: pointer; }
    
    #app-container { display: none; }
    #scan-ui { display: block; }
    #result-ui { display: none; animation: fadeIn 0.3s; padding-top: 10px; }
    
    .mode-group { display: flex; gap: 10px; margin-bottom: 15px; }
    .mode-label { flex: 1; padding: 12px; border: 2px solid #ddd; border-radius: 8px; cursor: pointer; font-weight: bold; background: #fafafa; transition: all 0.2s; color: #666; }
    .mode-label input { display: none; }
    .mode-label.active { border-color: #0d6efd; background: #e7f1ff; color: #0d6efd; }

    .dashboard-card { background: #333; color: #fff; padding: 15px; border-radius: 8px; margin-bottom: 15px; box-shadow: 0 4px 6px rgba(0,0,0,0.2); }
    .db-label { font-size: 0.9em; opacity: 0.8; margin-bottom: 5px; }
    .db-value { font-size: 2.2em; font-weight: bold; line-height: 1; }
    .db-total { font-size: 1em; opacity: 0.8; margin-left: 5px; }
    
    #reader { width: 100%; border-radius: 8px; overflow: hidden; margin-bottom: 10px; background: #000; min-height: 250px;}
    
    .status-box { padding: 15px; border-radius: 8px; font-weight: bold; font-size: 1.2em; margin-bottom: 10px; white-space: pre-wrap; }
    .status-success { background: #d1e7dd; color: #0f5132; border: 1px solid #badbcc; }
    .status-warn { background: #fff3cd; color: #664d03; border: 1px solid #ffecb5; }
    .status-error { background: #f8d7da; color: #842029; border: 1px solid #f5c2c7; }
    
    .highlight-info { margin: 20px 0; padding: 20px 10px; background: #f0f8ff; border: 4px solid #b3d7ff; border-radius: 12px; color: #004085; }
    .big-group { display: block; font-size: 2.5em; font-weight: 900; color: #0d6efd; line-height: 1.2; margin-bottom: 5px; word-break: break-all; }
    .big-no { display: block; font-size: 1.8em; font-weight: bold; color: #555; }
    
    .payment-alert { background: #ffebeb; border: 3px solid #ffcccc; color: #d00; padding: 15px; border-radius: 8px; margin: 15px 0; font-weight: bold; font-size: 1.2em; animation: pulse 2s infinite; }
    .payment-ok { background: #e8f5e9; color: #2e7d32; padding: 5px 10px; border-radius: 4px; font-size: 0.9em; display: inline-block; margin-top: 5px; border: 1px solid #c8e6c9; }
    
    .btn-next { display: inline-block; margin-top: 20px; padding: 15px 30px; background: #0d6efd; color: white; border: none; border-radius: 50px; font-size: 18px; font-weight: bold; cursor: pointer; width: 100%; box-shadow: 0 4px 10px rgba(13, 110, 253, 0.3); }
    .btn-next:active { transform: scale(0.98); }
    
    .list-section { margin-top: 30px; border-top: 2px dashed #ddd; padding-top: 20px; text-align: left; }
    .search-box { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 6px; box-sizing: border-box; margin-bottom: 10px; font-size: 16px; }
    
    .btn-reload { display: block; width: 100%; padding: 10px; margin-bottom: 10px; background: #f8f9fa; border: 1px solid #ddd; border-radius: 6px; color: #0d6efd; font-weight: bold; cursor: pointer; font-size: 14px; transition: background 0.2s; }
    .btn-reload:active { background: #e2e6ea; }
    
    #list-container { max-height: 400px; overflow-y: auto; }
    .user-row { display: flex; align-items: center; padding: 10px; border-bottom: 1px solid #eee; gap: 10px; }
    .user-row:last-child { border-bottom: none; }
    .user-info { flex: 1; }
    .user-name { font-weight: bold; display: block; }
    .user-meta { font-size: 0.8em; color: #666; }
    .btn-checkin-manual { padding: 6px 12px; background: #198754; color: #fff; border: none; border-radius: 4px; font-size: 0.9em; cursor: pointer; }
    
    .badge { display: inline-block; padding: 2px 6px; border-radius: 4px; font-size: 0.75em; margin-right: 4px; }
    .badge-grp { background: #e7f1ff; color: #0d6efd; font-weight: bold; }
    .badge-unpaid { background: #dc3545; color: white; }

    /* æ”¯æ‰•ã„ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ç”¨CSS */
    .btn-pay-action {
      display: inline-block;
      margin-top: 5px;
      padding: 8px 16px;
      background: #6610f2;
      color: white;
      border: none;
      border-radius: 4px;
      font-size: 0.9em;
      font-weight: bold;
      cursor: pointer;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    .btn-pay-action:active { transform: scale(0.98); }

    /* --- æ–°è¦è¿½åŠ : ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚¨ãƒªã‚¢ç”¨CSS --- */
    .filter-area {
      background: #f8f9fa;
      border: 1px solid #e9ecef;
      border-radius: 8px;
      padding: 10px;
      margin-bottom: 10px;
      font-size: 0.9em;
    }
    .filter-row {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 15px;
      margin-bottom: 5px;
      flex-wrap: wrap;
    }
    .filter-label {
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 4px;
    }
    .logic-toggle {
      background: #e9ecef;
      border-radius: 20px;
      padding: 3px;
      display: inline-flex;
    }
    .logic-opt {
      padding: 4px 12px;
      border-radius: 15px;
      cursor: pointer;
      font-weight: bold;
      color: #666;
    }
    .logic-opt.selected {
      background: #fff;
      color: #0d6efd;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    input[type="radio"].logic-radio { display: none; }
    /* ------------------------------------------- */

    @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(220, 53, 69, 0.4); } 70% { box-shadow: 0 0 0 10px rgba(220, 53, 69, 0); } 100% { box-shadow: 0 0 0 0 rgba(220, 53, 69, 0); } }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
  </style>
  <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
</head>
<body>

  <div class="container">
    <div id="login-ui">
      <h2>é‹å–¶ãƒ­ã‚°ã‚¤ãƒ³</h2>
      <p style="font-size:0.9em; color:#666; margin-bottom:20px;">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</p>
      <input type="password" id="pass-input" class="login-input" placeholder="Password">
      <br>
      <button class="btn-login" onclick="doLogin(false)">ãƒ­ã‚°ã‚¤ãƒ³</button>
      <div id="login-msg" style="color:#666; margin-top:10px; min-height:20px;"></div>
    </div>

    <div id="app-container">
      <div id="scan-ui">
        <div class="mode-group" id="mode-group-container"></div>

        <div class="dashboard-card">
          <div class="db-label" id="db-title">å—ä»˜çŠ¶æ³</div>
          <div>
            <span class="db-value" id="db-done">-</span>
            <span class="db-total">/ <span id="db-total">-</span> å</span>
          </div>
        </div>

        <div id="reader"></div>
        <div id="cam-status" style="font-size:0.9em; color:#666; margin-bottom:10px;">ã‚«ãƒ¡ãƒ©èµ·å‹•ä¸­...</div>
        
        <div class="list-section">
          <h3>ğŸ” æ‰‹å‹•ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³ / ãƒªã‚¹ãƒˆ</h3>
          <button class="btn-reload" onclick="loadList()">ğŸ”„ ãƒªã‚¹ãƒˆã‚’æ›´æ–°ã™ã‚‹</button>
          <input type="text" id="search-input" class="search-box" placeholder="åå‰ ã¾ãŸã¯ å—ä»˜No ã§æ¤œç´¢..." oninput="filterList()">
          
          <div class="filter-area">
            <div class="filter-row">
              <label class="filter-label">
                <input type="checkbox" id="chk-not-checkin" onchange="filterList()"> â³ æœªå—ä»˜
              </label>
              <label class="filter-label">
                <input type="checkbox" id="chk-unpaid" onchange="filterList()"> ğŸ’´ æœªæ‰•ã„
              </label>
            </div>
            <div class="filter-row">
              <span style="font-size:0.85em; color:#666; margin-right:5px;">æ¡ä»¶:</span>
              <div class="logic-toggle">
                <label class="logic-opt selected" id="lbl-and">
                  <input type="radio" name="logic" value="and" checked class="logic-radio" onchange="toggleLogic('and')"> AND
                </label>
                <label class="logic-opt" id="lbl-or">
                  <input type="radio" name="logic" value="or" class="logic-radio" onchange="toggleLogic('or')"> OR
                </label>
              </div>
            </div>
          </div>
          <div id="list-container">èª­ã¿è¾¼ã¿ä¸­...</div>
        </div>
        
        <div style="margin-top:30px; text-align:right;">
          <button onclick="doLogout()" style="background:none; border:none; color:#999; text-decoration:underline; cursor:pointer;">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
        </div>
      </div>

      <div id="result-ui">
        <div id="status-msg" class="status-box"></div>
        <div id="payment-area"></div>
        <div id="info-detail" style="text-align:left; background:#f9f9f9; padding:15px; border-radius:6px; margin:15px 0; font-size:1.1em;"></div>
        <button class="btn-next" onclick="resetScanner()">æ¬¡ã®äººã‚’ã‚¹ã‚­ãƒ£ãƒ³</button>
      </div>
    </div>
  </div>

  <script>
    let APP_CONFIG = {};
    try {
      APP_CONFIG = <?!= config ?>;
    } catch(e) {
      console.error('Config load failed', e);
      APP_CONFIG = { modes: { default: { label: 'Event' } } };
    }
  </script>

  <script>
    let html5QrcodeScanner = null;
    let currentModeKey = '';
    let isScanning = true;
    let participantList = []; 
    const STORE_KEY = 'scan_app_pass'; 

    window.onload = function() {
      initModeButtons();
      const savedPass = localStorage.getItem(STORE_KEY);
      if (savedPass) {
        document.getElementById('pass-input').value = savedPass;
        doLogin(true);
      }
    };

    // ----- åˆæœŸåŒ–: ãƒ¢ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³ã®ç”Ÿæˆ -----
    function initModeButtons() {
      const container = document.getElementById('mode-group-container');
      container.innerHTML = '';
      
      const modeKeys = Object.keys(APP_CONFIG.modes);
      if (modeKeys.length === 0) return;

      currentModeKey = modeKeys[0];

      if (modeKeys.length === 1) {
        container.style.display = 'none';
        updateDashboard();
        return;
      }

      modeKeys.forEach(key => {
        const mode = APP_CONFIG.modes[key];
        const label = document.createElement('label');
        label.className = 'mode-label';
        label.id = 'lbl-' + key;
        label.onclick = () => setMode(key);
        label.innerText = mode.label;
        container.appendChild(label);
      });

      updateModeUi();
    }

    function setMode(key) {
      currentModeKey = key;
      updateModeUi();
      filterList();
    }

    function updateModeUi() {
      const modeKeys = Object.keys(APP_CONFIG.modes);
      modeKeys.forEach(key => {
        const el = document.getElementById('lbl-' + key);
        if (el) el.classList.remove('active');
      });

      const activeEl = document.getElementById('lbl-' + currentModeKey);
      if (activeEl) activeEl.classList.add('active');

      updateDashboard();
    }

    function updateDashboard() {
      const titleEl = document.getElementById('db-title');
      const doneEl = document.getElementById('db-done');
      const totalEl = document.getElementById('db-total');

      const modeLabel = APP_CONFIG.modes[currentModeKey].label;
      titleEl.innerText = `${modeLabel} å—ä»˜çŠ¶æ³`;

      if (!participantList.length) {
        doneEl.innerText = '-';
        totalEl.innerText = '-';
        return;
      }

      let countDone = 0;
      let countTotal = 0;
      
      participantList.forEach(u => {
        const info = u[currentModeKey];
        if (info && info.eligible) {
          countTotal++;
          if (info.checkedIn) countDone++;
        }
      });
      doneEl.innerText = countDone;
      totalEl.innerText = countTotal;
    }

    // ----- ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãƒ­ã‚¸ãƒƒã‚¯åˆ¶å¾¡ -----
    function toggleLogic(val) {
      document.getElementById('lbl-and').className = 'logic-opt' + (val === 'and' ? ' selected' : '');
      document.getElementById('lbl-or').className = 'logic-opt' + (val === 'or' ? ' selected' : '');
      filterList();
    }

    // ----- ãƒ­ã‚°ã‚¤ãƒ³ãƒ»ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ -----
    function doLogin(isAuto) {
      const pass = document.getElementById('pass-input').value;
      const msg = document.getElementById('login-msg');
      msg.innerText = isAuto ? 'è‡ªå‹•ãƒ­ã‚°ã‚¤ãƒ³ä¸­...' : 'èªè¨¼ä¸­...';

      google.script.run
        .withSuccessHandler(function(isValid) {
          if (isValid) {
            msg.innerText = '';
            localStorage.setItem(STORE_KEY, pass);
            document.getElementById('login-ui').style.display = 'none';
            document.getElementById('app-container').style.display = 'block';
            startApp();
          } else {
            localStorage.removeItem(STORE_KEY);
            msg.innerText = 'ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé•ã„ã¾ã™';
            msg.style.color = 'red';
          }
        })
        .withFailureHandler(e => msg.innerText = 'ã‚¨ãƒ©ãƒ¼: ' + e)
        .verifyAppPassword(pass);
    }

    function doLogout() {
      if(confirm('ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã™ã‹ï¼Ÿ')) {
        localStorage.removeItem(STORE_KEY);
        location.reload();
      }
    }

    // ----- æ”¯æ‰•ã„æ›´æ–°å‡¦ç† -----
    function doUpdatePayment(id) {
      if (!confirm('ã€Œæ”¯æ‰•æ¸ˆã€ã¨ã—ã¦è¨˜éŒ²ã—ã¾ã™ã‹ï¼Ÿ\nï¼ˆã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã«ã€Œæ¸ˆã€ã¨å…¥åŠ›ã•ã‚Œã¾ã™ï¼‰')) return;

      google.script.run
        .withSuccessHandler(() => {
          alert('âœ… æ”¯æ‰•æƒ…å ±ã‚’æ›´æ–°ã—ã¾ã—ãŸ');
          
          const paymentEl = document.getElementById('payment-area');
          if (paymentEl && paymentEl.style.display !== 'none') {
             paymentEl.innerHTML = `<div class="payment-ok">ğŸ’° æ”¯æ‰•ç¢ºèªæ¸ˆ (ä»Šæ›´æ–°ã—ã¾ã—ãŸ)</div>`;
          }
          loadList();
        })
        .withFailureHandler(e => alert('ã‚¨ãƒ©ãƒ¼: ' + e))
        .updatePaymentStatus(id);
    }

    // ----- QRã‚¹ã‚­ãƒ£ãƒ³ -----
    function startApp() {
      html5QrcodeScanner = new Html5Qrcode("reader");
      
      // ã‚¹ã‚­ãƒ£ãƒ³é€Ÿåº¦ã‚’ä¸Šã’ã‚‹ãŸã‚ã®æœ€é©åŒ–è¨­å®š
      const config = { 
        fps: 30, // 10ã‹ã‚‰30ã«å¤‰æ›´ï¼ˆåå¿œé€Ÿåº¦ã‚¢ãƒƒãƒ—ï¼‰
        qrbox: { width: 250, height: 250 }, 
        aspectRatio: 1.0,
        // QRã‚³ãƒ¼ãƒ‰ã®ã¿ã‚’æ¢ã™ã‚ˆã†ã«åˆ¶é™ï¼ˆè¨ˆç®—å‡¦ç†ãŒçˆ†é€Ÿã«ãªã‚Šã¾ã™ï¼‰
        formatsToSupport: [ Html5QrcodeSupportedFormats.QR_CODE ] 
      };
      
      // ã‚¨ãƒ©ãƒ¼ã®åŸå› ã ã£ãŸ cameraConfig ã¯å‰Šé™¤ã—ã€å…ƒã®ã‚·ãƒ³ãƒ—ãƒ«ãªæŒ‡å®šã«æˆ»ã—ã¾ã™
      html5QrcodeScanner.start({ facingMode: "environment" }, config, onScanSuccess)
        .then(() => document.getElementById('cam-status').innerText = 'ã‚«ãƒ¡ãƒ©ã‚’QRã«å‘ã‘ã¦ãã ã•ã„')
        .catch(err => {
          document.getElementById('cam-status').innerText = 'ã‚«ãƒ¡ãƒ©èµ·å‹•ã‚¨ãƒ©ãƒ¼: ' + err;
          document.getElementById('cam-status').style.color = 'red';
        });

      loadList();
    }

    function onScanSuccess(decodedText) {
      if (!isScanning) return;
      handleCheckin(decodedText);
    }

    function handleCheckin(rawString) {
      isScanning = false;
      
      let id = rawString;
      if (rawString.includes('id=')) {
        const match = rawString.match(/id=([^&]+)/);
        if (match) id = decodeURIComponent(match[1]);
      }
      id = id.trim();

      // â˜…GASã«é€šä¿¡ã›ãšã€æ‰‹å…ƒã®ãƒ¡ãƒ¢ãƒª(participantList)ã‹ã‚‰ä¸€ç¬ã§æ¤œç´¢
      const user = participantList.find(u => u.checkinId === id);

      if (!user) {
        showResult({ success: false, message: 'âŒ IDãŒè¦‹ã¤ã‹ã‚‰ãªã„ã€ã¾ãŸã¯ã‚­ãƒ£ãƒ³ã‚»ãƒ«æ¸ˆã§ã™' });
        return;
      }

      const modeData = user[currentModeKey];
      if (!modeData) {
        showResult({ success: false, message: 'âŒ ä¸æ˜ãªãƒ¢ãƒ¼ãƒ‰ã§ã™' });
        return;
      }

      if (!modeData.eligible) {
        const modeLabel = APP_CONFIG.modes[currentModeKey].label;
        showResult({ success: false, message: `âš ï¸ ${user.name} æ§˜ã¯ã€${modeLabel} ä¸å‚åŠ ã€‘æ ã§ã™` });
        return;
      }

      // ãƒ­ãƒ¼ã‚«ãƒ«ã§ã®å—ä»˜çŠ¶æ…‹ã‚’ç¢ºèª
      const already = modeData.checkedIn;
      
      // ç”»é¢ã«æ¸¡ã™ãƒ‡ãƒ¼ã‚¿ã‚’ä½œæˆ
      const res = {
        success: true,
        already: already,
        checkinId: id,
        data: {
          name: user.name,
          ticket: user.ticket,
          attend: user.attend,
          receptionNo: user.receptionNo,
          total: user.total,
          group: modeData.group,
          paymentStatus: user.isPaid ? 'paid' : 'unpaid'
        }
      };

      // 0.01ç§’ã§ç”»é¢ã‚’æ›´æ–°
      showResult(res);

      // â˜…æœªå—ä»˜ã ã£ãŸå ´åˆã€ç”»é¢è¡¨ç¤ºã¨ä¸¦è¡Œã—ã¦ã€Œè£å´ã€ã§GASã«æ›¸ãè¾¼ã¿æŒ‡ç¤ºã‚’å‡ºã™
      if (!already) {
        // å…ˆã«æ‰‹å…ƒã®ãƒªã‚¹ãƒˆã‚’ã€Œå—ä»˜æ¸ˆã€ã«å¤‰æ›´ã—ã¦ãŠãï¼ˆå†ã‚¹ã‚­ãƒ£ãƒ³é˜²æ­¢ã¨ãƒªã‚¹ãƒˆå³æ™‚åæ˜ ï¼‰
        user[currentModeKey].checkedIn = true;
        updateDashboard();
        filterList();
        
        // è£ã§ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‚’æ›´æ–°ï¼ˆçµæœã‚’å¾…ãŸãªã„ï¼‰
        google.script.run
          .withFailureHandler(e => console.error('ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰æ›¸ãè¾¼ã¿ã‚¨ãƒ©ãƒ¼:', e))
          .markAsCheckedInBack(id, currentModeKey);
      }
    }

    function showResult(res) {
      document.getElementById('scan-ui').style.display = 'none';
      document.getElementById('result-ui').style.display = 'block';

      const statusEl = document.getElementById('status-msg');
      const detailEl = document.getElementById('info-detail');
      const paymentEl = document.getElementById('payment-area');

      if (res.success) {
        const groupDisp = res.data.group ? `<span class="big-group">${res.data.group}</span>` : '<span class="big-group" style="color:#666; font-size:1.5em;">ãƒ•ãƒªãƒ¼</span>';
        
        let statusHtml = '';
        let boxClass = '';
        if (res.already) {
          boxClass = 'status-warn';
          statusHtml = `âš ï¸ å—ä»˜æ¸ˆã¿ã§ã™`;
        } else {
          boxClass = 'status-success';
          statusHtml = `âœ… å—ä»˜å®Œäº†`;
        }
        statusEl.className = 'status-box ' + boxClass;

        statusEl.innerHTML = `
          <div class="highlight-info">
            <div style="font-size:0.9em; color:#666; margin-bottom:5px;">GROUP</div>
            ${groupDisp}
            <span class="big-no">No.${res.data.receptionNo}</span>
          </div>
          <div>${statusHtml}</div>
          <div style="font-size:1.6em; font-weight:bold; margin-top:10px;">${res.data.name} <span style="font-size:0.6em">æ§˜</span></div>
        `;
        
        if (res.data.paymentStatus === 'unpaid') {
          paymentEl.innerHTML = `
            <div class="payment-alert">
              âš ï¸ æœªæ‰•ã„ã§ã™ï¼<br>è«‹æ±‚é¡: ${res.data.total}å††
              <br>
              <button class="btn-pay-action" onclick="doUpdatePayment('${res.checkinId}')">
                Â¥ ç¾åœ°ã§æ”¯æ‰•ã£ãŸã®ã§æ¸ˆã«ã™ã‚‹
              </button>
            </div>
          `;
        } else {
          paymentEl.innerHTML = `<div class="payment-ok">ğŸ’° æ”¯æ‰•ç¢ºèªæ¸ˆ</div>`;
        }

        detailEl.innerHTML = `
          ãƒã‚±ãƒƒãƒˆ: ${res.data.ticket}<br>
          å‚åŠ å½¢æ…‹: ${res.data.attend}
        `;
      } else {
        statusEl.className = 'status-box status-error';
        statusEl.innerText = res.message;
        detailEl.innerHTML = '';
        paymentEl.innerHTML = '';
      }
      
      if(html5QrcodeScanner) {
        try { html5QrcodeScanner.pause(); } catch(e){}
      }
      
      // æ³¨æ„: ã“ã“ã«ã‚ã£ãŸ loadList() ã¯å‰Šé™¤ã—ã¾ã—ãŸï¼ˆãƒ­ãƒ¼ã‚«ãƒ«æ›´æ–°ã®ã¿ã«ã™ã‚‹ãŸã‚ï¼‰
    }

    function showError(e) {
      alert('ã‚¨ãƒ©ãƒ¼: ' + e);
      resetScanner();
    }

    function resetScanner() {
      document.getElementById('result-ui').style.display = 'none';
      document.getElementById('scan-ui').style.display = 'block';
      document.getElementById('cam-status').innerText = 'ã‚«ãƒ¡ãƒ©ã‚’QRã«å‘ã‘ã¦ãã ã•ã„';
      isScanning = true;
      if(html5QrcodeScanner) {
        try { html5QrcodeScanner.resume(); } catch(e) {}
      }
    }

    // ----- ãƒªã‚¹ãƒˆå‡¦ç† -----
    function loadList() {
      const btn = document.querySelector('.btn-reload');
      const originalText = btn.innerText;
      btn.innerText = 'æ›´æ–°ä¸­...';
      
      google.script.run
        .withSuccessHandler(function(list){
          participantList = list;
          updateDashboard(); 
          filterList();
          btn.innerText = originalText;
        })
        .withFailureHandler(e => {
          document.getElementById('list-container').innerText = 'ã‚¨ãƒ©ãƒ¼: ' + e;
          btn.innerText = originalText;
        })
        .getParticipantList();
    }

    // ----- ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼æ©Ÿèƒ½å®Ÿè£… -----
    function filterList() {
      const container = document.getElementById('list-container');
      const query = document.getElementById('search-input').value.toLowerCase();
      
      // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼æ¡ä»¶ã®å–å¾—
      const filterNotCheckin = document.getElementById('chk-not-checkin').checked;
      const filterUnpaid = document.getElementById('chk-unpaid').checked;
      const logicMode = document.querySelector('input[name="logic"]:checked').value; // 'and' or 'or'

      if (!participantList.length) {
        container.innerHTML = '<div style="padding:10px; color:#666;">ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã¦ãã ã•ã„</div>';
        return;
      }

      let html = '';
      const filtered = participantList.filter(u => {
        // 1. ãƒ†ã‚­ã‚¹ãƒˆæ¤œç´¢ (ANDæ¡ä»¶)
        const target = (u.name + ' ' + u.receptionNo).toLowerCase();
        const matchesText = target.includes(query);
        if (!matchesText) return false;

        // 2. çŠ¶æ…‹ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
        if (!filterNotCheckin && !filterUnpaid) return true; // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãªã—

        const modeData = u[currentModeKey];
        // è©²å½“ãƒ¢ãƒ¼ãƒ‰å¯¾è±¡å¤–ã®äººã¯ã€æœªå—ä»˜ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã®å¯¾è±¡å¤–ã¨ã™ã‚‹ï¼ˆè¡¨ç¤ºã—ãªã„ï¼‰
        if (!modeData || !modeData.eligible) return false;

        const isNotCheckin = !modeData.checkedIn;
        const isUnpaid = !u.isPaid;

        if (logicMode === 'and') {
          // AND: ãƒã‚§ãƒƒã‚¯ã•ã‚ŒãŸæ¡ä»¶ã™ã¹ã¦ã‚’æº€ãŸã™
          if (filterNotCheckin && !isNotCheckin) return false;
          if (filterUnpaid && !isUnpaid) return false;
          return true;
        } else {
          // OR: ãƒã‚§ãƒƒã‚¯ã•ã‚ŒãŸæ¡ä»¶ã®ã„ãšã‚Œã‹ã‚’æº€ãŸã™
          if (filterNotCheckin && isNotCheckin) return true;
          if (filterUnpaid && isUnpaid) return true;
          return false;
        }
      });

      if (filtered.length === 0) {
        container.innerHTML = '<div style="padding:10px;">è©²å½“è€…ãªã—</div>';
        return;
      }

      const limit = 50; // è¡¨ç¤ºåˆ¶é™
      
      filtered.slice(0, limit).forEach(u => {
        const modeData = u[currentModeKey];
        
        let btnHtml = '';
        if (!modeData || !modeData.eligible) {
          btnHtml = '<span style="color:#ccc; font-size:0.8em;">å¯¾è±¡å¤–</span>';
        } else if (modeData.checkedIn) {
          btnHtml = '<span style="color:#198754; font-weight:bold;">æ¸ˆ</span>';
        } else {
          btnHtml = `<button class="btn-checkin-manual" onclick="handleCheckin('${u.checkinId}')">ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³</button>`;
        }
        
        const grpBadge = modeData && modeData.group ? `<span class="badge badge-grp">${modeData.group}</span>` : '';

        // æœªæ‰•ã„ãƒãƒƒã‚¸
        let unpaidDisp = '';
        if (!u.isPaid) {
          unpaidDisp = `<span class="badge badge-unpaid">æœªæ‰•ã„</span>`;
        }

        html += `
          <div class="user-row">
            <div class="user-info">
              <div class="user-meta">No.${u.receptionNo} ${grpBadge}</div>
              <div style="margin-top:2px;">${unpaidDisp}</div>
              <span class="user-name">${u.name}</span>
            </div>
            <div>${btnHtml}</div>
          </div>
        `;
      });
      
      if (filtered.length > limit) {
        html += `<div style="text-align:center; padding:5px; color:#999;">ä»– ${filtered.length - limit} ä»¶...</div>`;
      }

      container.innerHTML = html;
    }
  </script>
</body>
</html>
